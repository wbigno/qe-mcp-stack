# .NET Coverage Analyzer MCP

**Type:** Docker MCP (Always Running)
**Port:** 3002
**Container:** `qe-dotnet-coverage-analyzer`
**Technology:** Node.js 18 + xml2js
**Status:** ✅ Production Ready

---

## Overview

The **.NET Coverage Analyzer** analyzes test coverage for .NET applications by:
1. **Parsing Cobertura XML coverage files** (generated by `dotnet test`)
2. **Scanning test files** to detect which methods have tests
3. **Analyzing test method names** to detect negative tests

Returns `N/A` for coverage percentages when coverage files don't exist, allowing the system to still provide test detection information without coverage data.

### Key Features

- ✅ **Coverage XML Parsing** - Parses `coverage.cobertura.xml` files from dotnet test
- ✅ **Test File Scanning** - Finds test files (`*Tests.cs`, `*Test.cs`) and detects test methods
- ✅ **Test Matching** - Matches test methods to source methods by naming patterns
- ✅ **Negative Test Detection** - Identifies negative tests by method name patterns
- ✅ **N/A Handling** - Returns `null` for coverage when files don't exist
- ✅ **No Mock Data** - All data is real or explicitly null

### What It Does NOT Do

- ❌ Does not execute tests (you must run `dotnet test` first)
- ❌ Does not generate tests
- ❌ Does not modify source code
- ❌ Does not store historical data or trends
- ❌ Does not calculate risk scores or generate recommendations

---

## Quick Start

### Generate Coverage Files (Required for Coverage %)

```bash
# Navigate to your test project
cd /Users/williambigno/dev/git/Payments/Tests/CarePayment.Test.Payments.Api

# Run tests with coverage collection
dotnet test --collect:"XPlat Code Coverage"

# Coverage file will be created at:
# TestResults/{guid}/coverage.cobertura.xml
```

### Analyze Coverage (Via Orchestrator)

```bash
# Analyze with code structure
curl -X POST http://localhost:3000/api/analysis/coverage \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "detailed": true
  }'
```

### Direct MCP Access (Testing Only)

```bash
# Basic analysis
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "codeStructure": {
      "methods": [
        {"name": "ProcessPayment", "file": "PaymentService.cs"}
      ]
    }
  }'

# Health check
curl http://localhost:3002/health
```

### Expected Output

**With Coverage Files:**
```json
{
  "success": true,
  "coverage": {
    "app": "Payments",
    "dataSource": "cobertura",
    "coverageFilesFound": 1,
    "message": "Coverage data from 1 file(s)",
    "overallPercentage": 87,
    "methods": [
      {
        "name": "ProcessPayment",
        "file": "PaymentService.cs",
        "coverage": 87,
        "hasTests": true,
        "hasNegativeTests": true,
        "testCount": 5
      }
    ]
  }
}
```

**Without Coverage Files:**
```json
{
  "success": true,
  "coverage": {
    "app": "Payments",
    "dataSource": "test-detection-only",
    "coverageFilesFound": 0,
    "message": "No coverage files found. Run: dotnet test --collect:\"XPlat Code Coverage\"",
    "overallPercentage": null,
    "methods": [
      {
        "name": "ProcessPayment",
        "file": "PaymentService.cs",
        "coverage": null,
        "hasTests": true,
        "hasNegativeTests": true,
        "testCount": 5
      }
    ]
  }
}
```

---

## Architecture

### Simple Design

```
┌────────────────────────────────────────────────────┐
│     Coverage Analyzer (Port 3002)                  │
│                                                     │
│  ┌──────────────┐   ┌──────────────┐              │
│  │   Express    │──▶│   Coverage   │              │
│  │   Router     │   │   Parser     │              │
│  └──────────────┘   └──────────────┘              │
│         │                   │                       │
│         ▼                   ▼                       │
│  POST /analyze      XML Parsing                    │
│  GET /health        Test Detection                 │
│                                                     │
└────────────────────────────────────────────────────┘
         │                    │
         ▼                    ▼
   Read coverage.xml    Scan *Tests.cs files
```

### Components

1. **Express Router** (`src/index.js`)
   - `POST /analyze` - Analyze coverage and tests
   - `GET /health` - Service health check

2. **Coverage Parser**
   - Finds `coverage.cobertura.xml` files
   - Parses XML with `xml2js`
   - Extracts method-level coverage percentages (0-100%)

3. **Test File Scanner**
   - Finds test files: `*Tests.cs`, `*Test.cs`, `Test*.cs`
   - Parses test methods with attributes: `[Test]`, `[Fact]`, `[Theory]`, `[TestMethod]`
   - Matches tests to source methods by name

4. **Negative Test Detector**
   - Analyzes test method names for patterns:
     - `Invalid`, `Error`, `Exception`, `Fail`, `Throw`
     - `Bad`, `Negative`, `Wrong`, `Should.*Not`
   - Sets `hasNegativeTests: true` if pattern found

### Dependencies

**Libraries:**
- `express` - HTTP server
- `xml2js` - XML parsing for Cobertura coverage files
- `glob` - File pattern matching

**File System Access:**
- `/mnt/apps/{app}` - Read application code and coverage files
- `/app/config` - Read apps.json configuration

---

## Configuration

### Environment Variables

Located in `.env` (root directory)

| Variable | Required | Default | Description |
|----------|----------|---------|-------------|
| `PORT` | ❌ No | 3002 | HTTP port |
| `CONFIG_PATH` | ❌ No | /app/config/apps.json | Config file path |

### Application Configuration

Applications must be defined in `config/apps.json`:

```json
{
  "applications": [
    {
      "name": "Payments",
      "displayName": "Payments System",
      "path": "/mnt/apps/Payments",
      "type": "dotnet",
      "framework": "net8.0",
      "testFramework": "xUnit"
    }
  ]
}
```

### Docker Configuration

Located in `docker-compose.yml`:

```yaml
dotnet-coverage-analyzer:
  build:
    context: ./mcps
    dockerfile: dotnet-coverage-analyzer/Dockerfile
  container_name: qe-dotnet-coverage-analyzer
  ports:
    - "3002:3002"
  volumes:
    - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
    - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
    - ./config:/app/config:ro
    - ./data/dotnet-coverage-analyzer:/app/data
  networks:
    - qe-network
  restart: unless-stopped
```

---

## API Reference

### POST /analyze

Analyze test coverage for an application

**Request Body:**
```typescript
{
  app: string;                    // Required: App name from apps.json
  codeStructure: {                // Required: Methods to analyze
    analysis?: {
      methods: Array<{
        name: string;
        file: string;
      }>;
    };
    methods?: Array<{             // Alternative format
      name: string;
      file: string;
    }>;
  };
  detailed?: boolean;             // Optional: Include test method details
}
```

**Response:**
```typescript
{
  success: boolean;
  coverage: {
    app: string;
    timestamp: string;
    dataSource: "cobertura" | "test-detection-only" | "none";
    coverageFilesFound: number;
    message: string;
    overallPercentage: number | null;  // null if no coverage files
    methods: Array<{
      name: string;
      file: string;
      coverage: number | null;         // null if no coverage data
      hasTests: boolean;               // true if test methods found
      hasNegativeTests: boolean;       // true if negative tests found
      testCount: number;
      testMethods?: Array<{            // If detailed=true
        name: string;
        isNegative: boolean;
      }>;
    }>;
    summary: {
      totalMethods: number;
      methodsWithCoverageData: number;
      methodsWithTests: number;
      untestedCount: number;
      partialCount: number;
      missingNegativeTests: number;
      coveragePercentage: number | null;
    };
  };
}
```

**Example Request:**
```bash
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "codeStructure": {
      "analysis": {
        "methods": [
          {"name": "ProcessPayment", "file": "PaymentService.cs"},
          {"name": "RefundPayment", "file": "PaymentService.cs"}
        ]
      }
    },
    "detailed": true
  }'
```

**Success Response (200):**
```json
{
  "success": true,
  "coverage": {
    "app": "Payments",
    "dataSource": "test-detection-only",
    "coverageFilesFound": 0,
    "message": "No coverage files found. Run: dotnet test --collect:\"XPlat Code Coverage\"",
    "overallPercentage": null,
    "methods": [
      {
        "name": "ProcessPayment",
        "file": "PaymentService.cs",
        "coverage": null,
        "hasTests": true,
        "hasNegativeTests": true,
        "testCount": 5,
        "testMethods": [
          {"name": "ProcessPayment_ValidCard_ReturnsSuccess", "isNegative": false},
          {"name": "ProcessPayment_InvalidCard_ThrowsException", "isNegative": true},
          {"name": "ProcessPayment_InsufficientFunds_ReturnsError", "isNegative": true}
        ]
      }
    ],
    "summary": {
      "totalMethods": 2,
      "methodsWithCoverageData": 0,
      "methodsWithTests": 1,
      "untestedCount": 1,
      "partialCount": 0,
      "missingNegativeTests": 0,
      "coveragePercentage": null
    }
  }
}
```

**Error Response (500):**
```json
{
  "success": false,
  "error": "Analysis failed",
  "message": "Application Payments not found in configuration",
  "stack": "Error: Application Payments not found..."
}
```

---

### GET /health

Service health check

**Response:**
```typescript
{
  status: "healthy";
  service: "coverage-analyzer-mcp";
  timestamp: string;
}
```

**Example:**
```bash
curl http://localhost:3002/health
```

**Response:**
```json
{
  "status": "healthy",
  "service": "coverage-analyzer-mcp",
  "timestamp": "2026-01-07T18:30:00.000Z"
}
```

---

## How It Works

### Coverage File Search

The analyzer searches for coverage files in these locations:
1. `{appDir}/**/TestResults/**/coverage.cobertura.xml`
2. `{appDir}/**/coverage.cobertura.xml`
3. `{appDir}/**/TestResults/**/coverage.xml`

If no files are found, `coverage` returns `null` for all methods.

### Test File Detection

Searches for test files matching these patterns:
1. `{appDir}/**/*Tests.cs`
2. `{appDir}/**/*Test.cs`
3. `{appDir}/**/Test*.cs`

### Test Method Matching

Matches test methods to source methods using these patterns:
- **Direct match**: `ProcessPayment` → `ProcessPaymentTests`, `Test_ProcessPayment`
- **Underscore removal**: `ProcessPayment` → `ProcessPayment_Should_Succeed`
- **Case insensitive**: Converts both to lowercase for comparison

### Negative Test Detection

Detects negative tests if method name contains:
- `Invalid`, `Error`, `Exception`, `Fail`, `Throw`
- `Bad`, `Negative`, `Wrong`
- `Should.*Not` (regex pattern)

**Examples:**
- ✅ `ProcessPayment_InvalidCard_ThrowsException` (negative test)
- ✅ `ValidateInput_WithNullValue_ThrowsArgumentError` (negative test)
- ✅ `Login_WithWrongPassword_ShouldNotSucceed` (negative test)
- ❌ `ProcessPayment_ValidCard_ReturnsSuccess` (positive test)

---

## Usage Examples

### Example 1: Analyze Without Coverage Files

**Scenario:** Check test coverage before running tests

```bash
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "codeStructure": {
      "methods": [
        {"name": "ProcessPayment", "file": "PaymentService.cs"}
      ]
    }
  }'
```

**Result:**
- `coverage`: `null` (no XML files)
- `hasTests`: `true` (test files found)
- `hasNegativeTests`: `true` (negative test patterns found)
- `message`: "No coverage files found. Run: dotnet test..."

**Action:** You know tests exist, but need to run them to get coverage %

---

### Example 2: Analyze With Coverage Files

**Scenario:** Check coverage after running tests

```bash
# 1. Run tests with coverage
cd /Users/williambigno/dev/git/Payments
dotnet test --collect:"XPlat Code Coverage"

# 2. Analyze
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "codeStructure": {
      "methods": [
        {"name": "ProcessPayment", "file": "PaymentService.cs"}
      ]
    }
  }'
```

**Result:**
- `coverage`: `87` (real % from XML)
- `hasTests`: `true`
- `hasNegativeTests`: `true`
- `dataSource`: "cobertura"

**Action:** Coverage data is now available

---

### Example 3: Detailed Test Information

**Scenario:** See which specific test methods exist

```bash
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d '{
    "app": "Payments",
    "codeStructure": {
      "methods": [
        {"name": "ProcessPayment", "file": "PaymentService.cs"}
      ]
    },
    "detailed": true
  }'
```

**Result:**
```json
{
  "methods": [{
    "name": "ProcessPayment",
    "testMethods": [
      {"name": "ProcessPayment_ValidCard_ReturnsSuccess", "isNegative": false},
      {"name": "ProcessPayment_InvalidCard_ThrowsException", "isNegative": true},
      {"name": "ProcessPayment_InsufficientFunds_ReturnsError", "isNegative": true}
    ]
  }]
}
```

**Action:** You can see exactly which tests exist for each method

---

## Generating Coverage Files

### Using dotnet test

```bash
# Navigate to test project
cd /path/to/your/TestProject

# Run tests with coverage collection
dotnet test --collect:"XPlat Code Coverage"

# Coverage file created at:
# TestResults/{guid}/coverage.cobertura.xml
```

### Using Coverlet

Add to your test project `.csproj`:

```xml
<PropertyGroup>
  <CollectCoverage>true</CollectCoverage>
  <CoverletOutputFormat>cobertura</CoverletOutputFormat>
  <CoverletOutput>./TestResults/</CoverletOutput>
</PropertyGroup>
```

Then run:
```bash
dotnet test
```

### Coverage File Format

The analyzer expects Cobertura XML format:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<coverage line-rate="0.87">
  <packages>
    <package name="Payments">
      <classes>
        <class name="PaymentService" filename="PaymentService.cs">
          <methods>
            <method name="ProcessPayment" line-rate="0.87"/>
          </methods>
        </class>
      </classes>
    </package>
  </packages>
</coverage>
```

---

## Troubleshooting

### Issue: Coverage shows N/A

**Symptoms:** `coverage: null` for all methods

**Cause:** No coverage files found

**Solution:**
```bash
# Generate coverage files
cd /path/to/test/project
dotnet test --collect:"XPlat Code Coverage"

# Verify file was created
find . -name "coverage.cobertura.xml"

# If file exists but not found, check paths
docker exec qe-dotnet-coverage-analyzer ls -la /mnt/apps/Payments/
```

---

### Issue: hasTests is false but tests exist

**Symptoms:** `hasTests: false` but test files exist

**Cause:** Test file naming doesn't match patterns or test methods not detected

**Solution:**
```bash
# Check test file names match patterns
# - *Tests.cs ✅
# - *Test.cs ✅
# - Test*.cs ✅
# - *_Tests.cs ❌

# Verify test methods have attributes
# [Test], [Fact], [Theory], [TestMethod]

# Check logs for detection
docker logs qe-dotnet-coverage-analyzer | grep "Found.*test file"
```

---

### Issue: Negative tests not detected

**Symptoms:** `hasNegativeTests: false` but negative tests exist

**Cause:** Test method names don't match negative patterns

**Solution:**

Use these naming patterns for negative tests:
- `MethodName_InvalidInput_ThrowsException` ✅
- `MethodName_WithNullValue_ReturnsError` ✅
- `MethodName_BadData_Fails` ✅
- `MethodName_ShouldNotSucceed` ✅
- `MethodName_UnhappyPath` ❌ (pattern not recognized)

---

### Issue: Service not starting

**Symptoms:** Container fails to start

**Cause:** Syntax error or missing dependency

**Solution:**
```bash
# Check logs
docker logs qe-dotnet-coverage-analyzer

# Rebuild container
docker compose build dotnet-coverage-analyzer
docker compose up -d dotnet-coverage-analyzer

# Verify health
curl http://localhost:3002/health
```

---

## Development

### Local Setup

```bash
cd mcps/dotnet-coverage-analyzer

# Install dependencies
npm install

# Run locally
npm start

# Test endpoint
curl http://localhost:3002/health
```

### Project Structure

```
mcps/dotnet-coverage-analyzer/
├── src/
│   └── index.js           # Main MCP implementation
├── package.json
├── Dockerfile
└── README.md
```

### Testing

```bash
# Test coverage parsing
curl -X POST http://localhost:3002/analyze \
  -H "Content-Type: application/json" \
  -d @test-payload.json

# Check logs
docker logs qe-dotnet-coverage-analyzer --tail 50
```

---

## Integration

### Used By

- **Orchestrator** (`/api/analysis/coverage`) - Primary consumer
- **Code Dashboard** (http://localhost:8081) - Displays coverage data

### Data Flow

```
1. Code Dashboard requests analysis
   ↓
2. Orchestrator calls code-analyzer for methods
   ↓
3. Orchestrator calls coverage-analyzer with methods
   ↓
4. Coverage-analyzer:
   - Searches for coverage.cobertura.xml
   - Scans for test files
   - Matches tests to methods
   - Returns coverage + test data
   ↓
5. Dashboard displays:
   - Coverage %: N/A (if no XML) or 87% (if XML found)
   - Has Test: ✅/❌ (real detection)
   - Has Negative Test: ✅/❌ (real detection)
```

---

## Changelog

### v2.0.0 (2026-01-07)
- ✅ **BREAKING:** Removed all mock data
- ✅ **NEW:** Real Cobertura XML coverage parsing
- ✅ **NEW:** Real test file scanning and detection
- ✅ **NEW:** Real negative test detection by name patterns
- ✅ **NEW:** Returns `null` for coverage when files don't exist
- ✅ **NEW:** Added `dataSource` field to response
- ✅ **NEW:** Added `coverageFilesFound` count
- ✅ **NEW:** Test method details with `detailed` parameter
- ✅ **CHANGED:** Single `/analyze` endpoint (removed mock endpoints)
- ✅ **REMOVED:** Historical tracking, risk scoring, recommendations

### v1.0.0 (2024-12-29)
- ⚠️ **DEPRECATED:** Mock data implementation
- ❌ All data was randomly generated

---

## Summary

**What it does:**
1. Parses real coverage XML files (`coverage.cobertura.xml`)
2. Scans real test files to detect test methods
3. Matches tests to source methods by naming patterns
4. Detects negative tests by method name patterns
5. Returns `N/A` (null) for coverage when XML files don't exist

**What it doesn't do:**
- ❌ No mock data
- ❌ No historical tracking
- ❌ No risk scoring
- ❌ No recommendations
- ❌ No test execution

**Key principle:** Real data or explicit `null` - never fake data.
