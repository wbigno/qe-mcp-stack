version: '3.8'

networks:
  qe-network:
    driver: bridge

volumes:
  orchestrator-data:
  dashboard-data:
  azure-devops-data:
  code-analyzer-data:
  coverage-analyzer-data:
  risk-analyzer-data:
  integration-mapper-data:
  playwright-generator-data:
  playwright-analyzer-data:
  playwright-healer-data:

services:
  # =============================================================================
  # Core Services
  # =============================================================================

  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    container_name: qe-orchestrator
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - AZURE_DEVOPS_MCP_URL=http://azure-devops:8100
      - THIRD_PARTY_MCP_URL=http://third-party:8101
      - TEST_PLAN_MANAGER_MCP_URL=http://test-plan-manager:8102
      - CODE_ANALYZER_MCP_URL=http://code-analyzer:8200
      - COVERAGE_ANALYZER_MCP_URL=http://coverage-analyzer:8201
      - MIGRATION_ANALYZER_MCP_URL=http://migration-analyzer:8203
      - RISK_ANALYZER_MCP_URL=http://risk-analyzer:8300
      - INTEGRATION_MAPPER_MCP_URL=http://integration-mapper:8301
      - TEST_SELECTOR_MCP_URL=http://test-selector:8302
      - PLAYWRIGHT_GENERATOR_MCP_URL=http://playwright-generator:8400
      - PLAYWRIGHT_ANALYZER_MCP_URL=http://playwright-analyzer:8401
      - PLAYWRIGHT_HEALER_MCP_URL=http://playwright-healer:8402
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - orchestrator-data:/app/data
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      azure-devops:
        condition: service_healthy
      code-analyzer:
        condition: service_healthy
      coverage-analyzer:
        condition: service_healthy

  dashboard:
    build:
      context: ./ado-dashboard
      dockerfile: Dockerfile
    container_name: qe-dashboard
    ports:
      - "5173:5173"
    environment:
      - VITE_ORCHESTRATOR_URL=http://localhost:3000
      - VITE_SWAGGER_HUB_URL=http://localhost:8000
    volumes:
      - dashboard-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    depends_on:
      - orchestrator

  swagger-hub:
    build:
      context: ./swagger-hub
      dockerfile: Dockerfile
    container_name: qe-swagger-hub
    ports:
      - "8000:8000"
    environment:
      - ORCHESTRATOR_URL=http://orchestrator:3000
      - AZURE_DEVOPS_URL=http://azure-devops:8100
      - THIRD_PARTY_URL=http://third-party:8101
      - TEST_PLAN_MANAGER_URL=http://test-plan-manager:8102
      - CODE_ANALYZER_URL=http://code-analyzer:8200
      - COVERAGE_ANALYZER_URL=http://coverage-analyzer:8201
      - MIGRATION_ANALYZER_URL=http://migration-analyzer:8203
      - RISK_ANALYZER_URL=http://risk-analyzer:8300
      - INTEGRATION_MAPPER_URL=http://integration-mapper:8301
      - TEST_SELECTOR_URL=http://test-selector:8302
      - PLAYWRIGHT_GENERATOR_URL=http://playwright-generator:8400
      - PLAYWRIGHT_ANALYZER_URL=http://playwright-analyzer:8401
      - PLAYWRIGHT_HEALER_URL=http://playwright-healer:8402
    networks:
      - qe-network
    restart: unless-stopped
    depends_on:
      - orchestrator

  # =============================================================================
  # Integration MCPs (8100-8199)
  # =============================================================================

  azure-devops:
    build:
      context: ./mcps/integration/azure-devops
      dockerfile: Dockerfile
    container_name: qe-azure-devops
    ports:
      - "8100:8100"
    environment:
      - NODE_ENV=production
      - PORT=8100
      - AZURE_DEVOPS_ORG=${AZURE_DEVOPS_ORG}
      - AZURE_DEVOPS_PAT=${AZURE_DEVOPS_PAT}
      - AZURE_DEVOPS_PROJECT=${AZURE_DEVOPS_PROJECT}
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - azure-devops-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  third-party:
    build:
      context: ./mcps/integration/third-party
      dockerfile: Dockerfile
    container_name: qe-third-party
    ports:
      - "8101:8101"
    environment:
      - NODE_ENV=production
      - PORT=8101
      - STRIPE_API_KEY=${STRIPE_API_KEY}
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - ./data/third-party:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8101/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  test-plan-manager:
    build:
      context: ./mcps/integration/test-plan-manager
      dockerfile: Dockerfile
    container_name: qe-test-plan-manager
    ports:
      - "8102:8102"
    environment:
      - NODE_ENV=production
      - PORT=8102
      - AZURE_DEVOPS_ORG=${AZURE_DEVOPS_ORG}
      - AZURE_DEVOPS_PAT=${AZURE_DEVOPS_PAT}
    env_file:
      - .env
    volumes:
      - ./config:/app/config:ro
      - ./data/test-plan-manager:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8102/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # =============================================================================
  # Code Analysis MCPs (8200-8299)
  # =============================================================================

  code-analyzer:
    build:
      context: ./mcps/code-analysis/code-analyzer
      dockerfile: Dockerfile
    container_name: qe-code-analyzer
    ports:
      - "8200:8200"
    environment:
      - NODE_ENV=production
      - PORT=8200
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - code-analyzer-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8200/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  coverage-analyzer:
    build:
      context: ./mcps/code-analysis/coverage-analyzer
      dockerfile: Dockerfile
    container_name: qe-coverage-analyzer
    ports:
      - "8201:8201"
    environment:
      - NODE_ENV=production
      - PORT=8201
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - coverage-analyzer-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8201/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  migration-analyzer:
    build:
      context: ./mcps/code-analysis/migration-analyzer
      dockerfile: Dockerfile
    container_name: qe-migration-analyzer
    ports:
      - "8203:8203"
    environment:
      - NODE_ENV=production
      - PORT=8203
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - ./config:/app/config:ro
      - ./data/migration-analyzer:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8203/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # =============================================================================
  # Quality Analysis MCPs (8300-8399)
  # =============================================================================

  risk-analyzer:
    build:
      context: ./mcps/quality-analysis/risk-analyzer
      dockerfile: Dockerfile
    container_name: qe-risk-analyzer
    ports:
      - "8300:8300"
    environment:
      - NODE_ENV=production
      - PORT=8300
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    env_file:
      - .env
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - risk-analyzer-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8300/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  integration-mapper:
    build:
      context: ./mcps/quality-analysis/integration-mapper
      dockerfile: Dockerfile
    container_name: qe-integration-mapper
    ports:
      - "8301:8301"
    environment:
      - NODE_ENV=production
      - PORT=8301
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - integration-mapper-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8301/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  test-selector:
    build:
      context: ./mcps/quality-analysis/test-selector
      dockerfile: Dockerfile
    container_name: qe-test-selector
    ports:
      - "8302:8302"
    environment:
      - NODE_ENV=production
      - PORT=8302
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    env_file:
      - .env
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - ./data/test-selector:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8302/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # =============================================================================
  # Playwright MCPs (8400-8499)
  # =============================================================================

  playwright-generator:
    build:
      context: .
      dockerfile: mcps/playwright/playwright-generator/Dockerfile
    container_name: qe-playwright-generator
    ports:
      - "8400:8400"
    environment:
      - NODE_ENV=production
      - PORT=8400
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=claude-sonnet-4-20250514
    env_file:
      - .env
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - playwright-generator-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8400/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  playwright-analyzer:
    build:
      context: .
      dockerfile: mcps/playwright/playwright-analyzer/Dockerfile
    container_name: qe-playwright-analyzer
    ports:
      - "8401:8401"
    environment:
      - NODE_ENV=production
      - PORT=8401
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=claude-sonnet-4-20250514
    env_file:
      - .env
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - playwright-analyzer-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8401/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  playwright-healer:
    build:
      context: .
      dockerfile: mcps/playwright/playwright-healer/Dockerfile
    container_name: qe-playwright-healer
    ports:
      - "8402:8402"
    environment:
      - NODE_ENV=production
      - PORT=8402
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=claude-sonnet-4-20250514
    env_file:
      - .env
    volumes:
      - /Users/williambigno/dev/git/Core:/mnt/apps/Core:ro
      - /Users/williambigno/dev/git/Core.Common:/mnt/apps/Core.Common:ro
      - /Users/williambigno/dev/git/Payments:/mnt/apps/Payments:ro
      - /Users/williambigno/dev/git/PreCare:/mnt/apps/PreCare:ro
      - /Users/williambigno/dev/git/ThirdPartyIntegrations:/mnt/apps/ThirdPartyIntegrations:ro
      - ./config:/app/config:ro
      - playwright-healer-data:/app/data
    networks:
      - qe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8402/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
